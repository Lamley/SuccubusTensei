;貸本屋
@COM620
#DIM CHARISMA
PRINTL 「借书每本一律\3000」
$C_LOOP
PRINT [1] 戦術指南書

IF ITEM:101
	PRINTFORML （被%CALLNAME:MASTER%借着）
ELSEIF GETBIT (FLAG:1011,1)
	PRINTL （借出中）
ELSE
	PRINTL 　
ENDIF
PRINT [2] 調理指南書
IF ITEM:102
	PRINTFORML （被%CALLNAME:MASTER%借着）
ELSEIF GETBIT (FLAG:1011,2)
	PRINTL （借出中）
ELSE
	PRINTL 　
ENDIF
PRINT [3] 字典
IF ITEM:103
	PRINTFORML （被%CALLNAME:MASTER%借着）
ELSEIF GETBIT (FLAG:1011,3)
	PRINTL （借出中）
ELSE
	PRINTL 　
ENDIF
PRINT [4] 御伽草子
IF ITEM:104
	PRINTFORML （被%CALLNAME:MASTER%借着）
ELSEIF GETBIT (FLAG:1011,4)
	PRINTL （借出中）
ELSE
	PRINTL 　
ENDIF
IF !CHARISMA
	PRINTFORML [100] 籌碼付款
ELSE
	PRINTFORML [100] 現金支付
ENDIF
DRAWLINE
PRINTL [0] 放弃

$LOOP
INPUT
IF ITEM:101 || ITEM:102 || ITEM:103 || ITEM:104
	PRINTL 「不能同时借二冊以上」
	RETURN -1
ELSEIF RESULT == 100
	IF !CHARISMA
		PRINTFORMW 「籌碼付款？？？？」
		PRINTFORMW 「嗯……那么就10个籌碼？可以么……」
		IF MONEY:2 < 10
			PRINTFORMW 籌碼不足
			GOTO C_LOOP
		ENDIF
	ELSE
		PRINTFORMW 「啊，我用钱支付吧」
	ENDIF
	PRINTFORML 
	CHARISMA = !CHARISMA
	GOTO C_LOOP
ELSE
	IF RESULT >= 1 && RESULT <= 4
		IF GETBIT (FLAG:1011,RESULT)
			PRINTL 「正在外借中呢」
		ELSE
			SETBIT FLAG:1011,RESULT
			IF !CHARISMA
				MONEY -= 3000
			ELSE
				MONEY:2 -= 10
			ENDIF
			ITEM:(100 + RESULT) = 1
			FLAG:貸本返却期限 = 8
			TFLAG:193 = 1
			PRINTFORML 借走了%ITEMNAME:(100 + RESULT)%
			RETURN 1
		ENDIF
	ELSEIF RESULT == 0
		RETURN -1
	ELSE
		GOTO LOOP
	ENDIF
ENDIF
TIME += 30

;貸本屋
@COM_ABLE620
;一括管理
SIF GLOBAL_COMABLE(620)
	RETURN RESULT
IF !AT_HOME(MASTER)
	SIF CFLAG:MASTER:現在位置 != 商家町
		RETURN 0
ELSE
	SIF CFLAG:MASTER:現在位置 != 213
		RETURN 0
ENDIF

SIF MONEY < 3000
	RETURN 0
;睡眠中
SIF CFLAG:睡眠
	RETURN 0
;時間停止中
SIF FLAG:70
	RETURN 0
RETURN 1

@BOOKLEND

FOR LOCAL,1,4
	SIF !ITEM:(100 + LOCAL) && !RAND:3
		INVERTBIT FLAG:1011,LOCAL
NEXT
SIF FLAG:貸本返却期限
	FLAG:貸本返却期限 -= 1
IF FLAG:貸本返却期限 == 1
	ITEM:101 = 0
	ITEM:102 = 0
	ITEM:103 = 0
	ITEM:104 = 0
	PRINTL 因為还书时限到了、把借来的书帰还了。
ENDIF