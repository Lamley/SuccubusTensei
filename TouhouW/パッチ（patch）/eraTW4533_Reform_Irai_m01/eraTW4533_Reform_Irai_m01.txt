2017/07/25
依頼改造した
eraTW4.533用依頼大改造人柱パッチm01


◆説明
・依頼関連処理の大改造
・大きなバグは潰したつもり
・各キャラ専用の依頼だけではなく、全てのキャラに発生する「一般依頼」を用意
・依頼の方向性を増やした
　例）
　・落とし物を持ち主（不明）に届けて欲しい
　・落とし物をしたから見つけて欲しい
　・手紙書いたから届けて欲しい
・ナズーリン固有コマンド「ダウジング」を実装
　上記のような依頼を実装したらこれがないとやってられんと思った
　すごく頼りになるよ！ただし金は取られる
・各キャラに固有の依頼も増やした
　が、ろくにテストしてない
　上手く動いてないかも



◆対象環境
eraTW4.533（バニラ環境）
他パッチとの競合は調べていません



◆つくったひと：morph
・morphのつくった以外のところの扱いはつくったひとに聞いて下さい
・配布・改造・流用、好きにしてください
・でも、その際のサポートは自分でやってね

※　era＝R-18全般の常識的な取り扱いとして例えば以下のような事はやめて下さい

・未成年者がいっぱいいる場所で広める
・R-18以外のモノをメインに扱ってる場所で取り上げる



◆注意点
・バグが潰しきれてません
　起動エラーくらいは潰したハズ
　こまかな不具合とかバランスが変だとか
　依頼実行可能な条件がわかりにくいだとかそういうの
　個々の依頼の実行条件もおかしいのがあるはず
・セーブデータを引き継ぐ場合には必ずSHOPにて依頼リセットを行うこと（変数の仕様が変わっています）
・キャラのセリフ
　全部無言というのも味気ないので
　霊夢さんがサンプル扱いってことでそこそこ喋ります
　さとり口上は明確に加筆NGだったのでとりあえずセリフ無し
　他は適当に（仮実装と思って下さい）
　morphの実装分に関しては口上作者さんの意向の方を優先して下さい
　うちの子はこんなこと言わないとかこんな依頼出さないよと思ったら
　意見くれるなり変えちまうなりして下さい
　このパッチより後発の口上であっても、口上作者さんの意向を優先して下さい
　最終的には本体管理者さんの判断にゆだねます
・早くて効率的な処理とかわかんないっす
　うん、わからん
　処理速度とか効率とかはさっぱりわからんので
　とりあえず見様見真似で追加できそうなシステムにはしたつもり
　まー、結局のところ各種判定を必要とする箇所では新規作者の参入はなかなか難しいよなぁとは思う
　適切なIFが設定できれば作れるのだけれど、それが「簡単」かといえばねぇ
・設計上は固有依頼は各キャラ800種類とか積めるが
　そんなことすると絶対に抽選ループが重くなるからやめれ（杞憂）



◆内容
依頼関連処理の大幅な変更
・例によって@OBJ_EXIST系の技術を使いまくった
・依頼の大分類として一般依頼/固有依頼を設定
　依頼発注キャラの偏りを減らすことができる
　従来はキャラに固有の依頼が多かったが未設定のキャラでも一般依頼は発生するよ
　一般依頼は1～99までの99種類、固有依頼は各キャラ101～999の899種類作れる
・依頼発生の流れ
　１．発注キャラの抽選（全体から10キャラ、重複あり、均等に抽選される）
　２．依頼スカ/一般依頼/固有依頼のどれかを発生抽選（キャラごとに確率を設定可能）
　３．一般依頼/固有依頼で依頼IDの抽選（依頼ごとに個別に確率を設定）
　となってます
・依頼の小分類として依頼内容を設定
　主にABLE系などで共通した処理を抜き出して簡素化するため
　（これに頼らず独自に設定することも可能）
　例）
　実行すると時間が経過して終わる「作業」、
　特定人物との接触を求める「伝令（人物）」、
　基本的に伝令と同一だがTARGETが不明な「捜索（人物）」、etc.
・IRAI_SLOTに依頼IDを突っ込むがこの際にCLIENTの番号が記録されるようにした
　CLIENT * 1000 + 依頼ID で記録してます
　固有依頼IDが101～でキャラ間で被るという関係上、CLIENTのIDを記録して区別する必要がありました
　TARGET（人物/物品/場所）が存在する系の依頼の場合は同様にIRAI_DATAに記録
・依頼発生直後に依頼が消滅しないように、また、依頼終了直後にも依頼が発生しないように
　地味に気になってたので改良
　失敗後・期限切れになってからも依頼者に会うまで依頼スロットは空きません
・依頼発生時に依頼IDではなくランダムに抽選を行う
　先に抽選処理で10キャラ程度を抽選してから依頼を発生させることにした

・追加した固有コマンド
　ナズーリンの「ダウジング」コマンド
　捜索系依頼のお供に
　この手のヒントが無いと場所or人物の総当りになってしまう
　キャラ設定が活かせる要素はとてもよいね



◆COMMONに追加した汎用関数
・キャラの登場判定F関数@CAN_MEET
・キャラのランダム選抜F関数@RAND_PERSON
・自宅位置取得F関数@GET_CHARAHOME
・場所名取得F関数@GET_PLACENAME
・配列抽選F関数@ARRAY_HIT
・配列RAND化F関数@ARRAY_RAND
・FISHER_YATES_SHAFFLE（F関数版）@FUNC_FISHER_YATES_SHAFFLE
・複数行自動表示関数@PRINT_GROUP



◆懸念事項
・独自解釈多いかもだ
　小町の固有依頼や手紙の宛先など
・バランスは超適当
・場所判定関連に自信がありません
　つかTW独自のF関数系を把握しきれてない
・口上関連の仕様がわからん
　ひとまず仮実装ということで
　適当に好き勝手実装しちまったけれどこれでよかったのやら？
　口上色の処理等は全然使用しておらず、依頼関連のメッセージはデフォ色で表示される
・宴会関連の仕様がわからん
　＜宴会用の酒＞は一般依頼でもよかったかもだが
　宴会関連の仕様をよく調べてなくてとりあえず霊夢の固有依頼という形でじっそうしたよ
・一般依頼化してもよさそうな固有依頼
　全体的にあまり深く考えずにとりあえずの実装です
　例）夏にみんなにアイスをくれと言われるのは有りだと思うね
・メッセージウェイトのタイミング
　あんま検証してません、適宜調整してね
・依頼リストラの影響
　ITEM:214を利用する処理自体は残っているがITEM:宿題の入手手段が無くなった
　コードだけ読むと混乱しかねないので一応、記す



◆作者さんへ（未実装の依頼など）
・現在、依頼フォルダ内の旧依頼ファイルは使用していません
　[SKIPSTART][SKIPEND]で飛ばしてます
・今後の課題TXTにあったさとりんの図書おつかいは実装しますた
　＞本といえばさとりんの小説の編集やりたい。資料集めとして図書館から本持ってきたり。
　＞しかし現行の依頼システムではキャラが対象となるのが前提なので、場所を指定するお使いイベント作るにはちょいと手を加える必要があるか。
　これを読んで作ったわけでもなく同じ発想で勝手に作って実装
　人里鈴奈庵、もしくは紅魔館大図書館を対象に貸出/返却の依頼をつくりました
　阿求も同様に取材してこいとか本借りてこいとかあってもいいのかも？

・永琳依頼案はちと実装むりだった
　＞永遠亭に住んでる場合、えーりんに発情抑える薬の材料取って来いと依頼される。
　＞満月（15日）までにやっておかないとイナバたちに逆レされて翌日足腰立たなくなる上に、えーりん以外の永遠亭住人から顰蹙を買う。
　現状の依頼発生処理では確率だよりで安定しない方式に変えてしまったので工夫が必要
　ざっくり実装を考えるとこんな感じかな？
　１．同一デイリーで日付によって挙動を変える
　２．15日はお月見会デイリー
　　　依頼達成済み→平和なお月見会、永遠亭のキャラの好感度+5とか、りんごせーらんも来る？
　　　依頼達成失敗→発情、大騒乱、顰蹙
　３．15日以外は依頼発生デイリー
　　　よろしく頼むわね的なコメント
　　　このタイミングで依頼を受託させる
　４．えーりん固有依頼の仕様
　　　・依頼発生率0にして、イベント限定で受託可能
　　　・とにかく常に依頼スロットに居座る状態にしておく
　　　・期限は30とかにしとけばよし、お月見会の時に伸ばす処理も作れる
　　　・永遠亭在住で無ければ消滅
　　　・実行条件はおもいつかんがてきとうに
　　　　薬草採取？？？
　５．依頼の成功失敗判定
　　　・依頼実行コマンドの戻り値を1にして、常に依頼を続行させる
　　　・これだけやっても依頼破棄はできるがそれは仕方なし
　　　・依頼の成功失敗はIRAI_SUBの蓄積量によって決まる
　　　　依頼実行の度に蓄積するように記述しておく
　　　・もしも固有依頼が依頼スロットに存在しないなら即失敗
　　　・もしくはデイリー側で変数を設けて管理する
　
　毎日発生するデイリーと連動させることによって
　指定する場所が毎朝変化する伝令（場所）依頼が作れるかもしれない

・ゆうかりんの依頼もつくってない
　＞家庭菜園拡張。理想としては何度も収穫してるとゆうかりんの依頼が発生する、達成すると畑が増える的な。
　家庭菜園の仕様を把握してない
　むしろデイリーにして唐突に訪れては家庭菜園をチェックして
　あれやこれや好き勝手に論評する方がらしいかも
　手入れが悪いと大暴れしてマップを汚して去っていくのだ

・実装できなかった一般依頼
　＜キスをください＞
　陥落済みキャラ限定
　ファーストキス処理のなんやかんやがわからなかったので見送り
