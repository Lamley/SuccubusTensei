2017/02/09
衣装大改造人柱パッチ01

※人柱版と思って下さい
　改造範囲が広いため、多くの不具合を内包している可能性が非常に高いです



◆対象環境
eraTW4.48protoバニラ環境

以下のパッチは全てマージしたので、これらのパッチのみを適用している場合も大丈夫
eraT0009659　eraTW4.48proto用プチ修正+α
eraT0009662　eraTW4.48proto用色々バグ修正
eraT0009669　eraTW4.48proto用バグ修正+α
eraT0009677　eraTW4.48proto用パンツ関連修正
eraT0009679　eraTW4.48proto用バスルーム脱衣問題その他修正
eraT0009682　eraTW4.48proto用挿入不可バグ修正

注意）
資料フォルダ・改造とかしてみたい人のためのあれこれフォルダは取り込んでません
CSVとERBだけです



◆仕様について
とりあえず作っただけの暫定の仕様です
ERB\衣服\CLOTHES.ERBの冒頭を参照
殴り書きすぎて何書いてあるんだかわかんないかもしんない
ごめん
あとデバッグ用にSHOPコマンド追加してます（あんま意味ないかもだが）



◆雑感
ファイル構成とか関数の配置とか見なおしたほうがいいかも
類似の処理が分散してたり同じような関数がいくつもあったり
（まぁ自分も類似処理は作っちゃってますが）
これに関してはパッチで対応はできませんので思っただけ

特に表示まわりは全体的にもっと関数を分けたほうがいいって処理が多い
具体的には@SHOW_STATUSはとりとめもなくぐだぐだと処理が続くので切り分けてったほうがいい

衣装セット番号などの数値分布については以前の仕様を引き継いでいるだけで
配置の最適化などは一切考慮しておりません
とりあえず作った！ってだけだからねコレ



衣装関連処理の何がややこしいって変数が分散してんのよね
EQUIP、TEQUIPはともかくCFLAGとCSTRは予想していなかった、と思ってたらTCVARまで顔を覗かせる始末

CFLAGの内容をCSVに記述した
・CFLAG:623はとりあえず廃止
・CFLAG:650＝パジャマ指定、毎日のパジャマを衣装セットIDで指定する、301ならパンイチ、302なら全裸
・CFLAG:651＝きょうのぱんつ、一日の始まりのパンツ抽選処理で選択されたパンツ
・CFLAG:652＝パジャマパンツ、一日の始まりのパンツ抽選処理で選択されたパンツ（パジャマ用の予備パンツ）
・CFLAG:653＝指定パンツ、MASTERに指定されたパンツ（ノーパン指定可）
・CFLAG:655＝お気に入り衣装、お気に入り指定衣装の有無
・CFLAG:656＝衣装一時変更、これが立っているときは服を脱がすコマンドを実行するまで普段着に戻らない
・CFLAG:700＝着替え実行、MASTERの目の前でお着替えしてくれる

・CFLAG:200、240、600の仕様変更
　こいつらは元々は各衣装のEQUIP:0の状態を記録してたわけだけど
　処理を変更して@CLOTHES_SETTING_TRAINにEQUIP:0の更新処理を仕込んだ結果
　不要になりました

・CFLAG:7の仕様変更
　各キャラのデフォルトでのCFLAG:7は0とした
　ADDCHARAの際にCSV準拠で設定されるがERB側で書き換える
　従来の仕様では、普段着の設定は各キャラの場合の場合はNOと対応しており、
　なりきりモードMASTERの場合にはFLAG:なりきりと対応している
　他の変数を参照して衣装を決定する事ができるため、霊夢で101などと設定しておく意義は薄い
　
　新仕様としては、このCFLAGは行動中の衣装の設定で使用される
　0以外の数値である時、毎日の衣装更新処理でその数値に対応した衣装を普段着として設定する
　1～99は衣装セットの数値と解釈される
　100の時は登録されているお気に入り衣装を普段着として着用する
　101～299は特定キャラの普段着を参照する（存在しないキャラは不可能）
　
　CFLAGを書き換えれば毎日みこかせんとかできる


いじる必要のある範囲が広すぎて正直、全容を把握できていません
・EQUIP系、衣装関連CFLAGはたぶん大丈夫（不具合あっても直せそう）
・CSTRはよくわかんないが特にいじってない（問題ない、ほぼフレーバー？）
・TCVARは大丈夫（使用してる箇所がすくない、問題もなさそう）
・TEQUIPは理解が追いついてない、カウンター脱衣とか調教中、うふふ中の挙動がまったくわからん



◆衣装の修正
全体に以前の仕様を引き継いでるものが多いです
morphが明白な誤りだと判断したものだけ修正しました
この娘の衣装はこうだ！って思ったら指摘してくらさい
全体的に公式露出のたびに衣装変わってたりするのが悩ましいよね

・ヘカTがTシャツ着てなかった、鈴湖も
・明羅の衣装が色々おかしかったのでざっくりと和装にした
・魔理沙、諏訪子に帽子をかぶらせた
・ルーミアにリボンつけた
・白蓮さんの下着を通常のブラジャーに変更した
　たぶんコレ、EQUIP:ARG:ワンピース = 9（ゴスロリドレス）をコピペして数値そのままにしちゃったパターンかな
・小悪魔がベスト（外衣）着てないから設定した（とりあえず画像表示にあわせる）
・萃香の拘束具（その他）が無いから設定した
・理香子に白衣（外衣）着せた、上着も着てるけど気にしない
・小町に帯（その他）を設定した、靴下は足袋に
・橙にイヤリング（その他）を設定した（とりあえずピアス未実装、他につける娘いるのか？）
・青娥の帽子を髪飾り（頭装備）に変更した
・影狼にブローチ（その他、新装備）をつけてあげた
　あのブローチはかなり目立つので良改変だと自負
・レティにもブローチ（その他、新装備）追加
　このほかにブローチ装備のひとっていたっけ？
・マミゾウの普段着に髪飾り（頭装備）を追加、葉っぱ
・蛮奇の帽子はおそらくリボンの誤り、その他装備のマフラーも微妙（保留）
・屠自古に護符（その他）追加、スカートの裾ね
・わかさぎ姫に帯（その他）を追加
・雷鼓にベルト（その他）とネクタイ（その他）を追加
・正邪にブレスレット（その他）を追加
・神子にブレスレット（その他）追加
・純狐に帯（その他）を追加
・衣玖さんが羽衣（その他）つけてないから設定した
・パルスィにマフラー（その他）と帯（その他）を追加した
　若干のコレジャナイ感あるけど近似解ってことで許して
　腕には新装備のアームカバーを追加
・幽々子に帽子（頭装備）と帯（その他）を追加
　あれは着物でいいのかとかあるけどとりあえずこれで勘弁してくれ
・布都の衣装変更
　道士服（ワンピース）→水干（上半身上着、新装備）＋ミニスカート（スカート）に変更
　道士服は八雲のあの服のイメージが強いので変更したかったの
・うどん薬売りセットを微修正
　手甲（腕部装束）追加、包帯（その他）追加
　包帯は脚に巻いてるゲートルっぽいアレの代用
・マミゾウ和装セット修正
　秋冬にシャツ（上半身上着）を着るのを羽織（外衣）に変更（コメントにあわせた）

保留事項
・蛮奇のマフラーってどうなのよ？（とりあえず冬限定にしてある）
・大チルちぇんあたりの衣装
　ワンピースっつーよりもブラウス＋ジャンパースカートっぽくねと思うも保留
　衣服の上下分離具合がよくわからん
・幽香のスカーフタイ装備
　あの手の襟元のリボンを装備品として着用させると
　（霊夢を筆頭に）装備者が大幅に増えるような気がする～
　他キャラは設定してません
・椛のスカート
　袴派もいるんだろうなぁ、と
　まー、好きに変えて下さいね？
・菫子の衣装
　画像表示との乖離が著しい



◆改造内容
膨大すぎて全部は書けないが覚えてる範囲で

・OBJフォルダ
このパッチの要、目玉システム
試しにCLASSフォルダ内の衣装セット.ERBでも覗いてみてください
きっと構文読めなくてもなんとなく意味がわかる（と、いいなぁ）
全体的な処理の仕組みはえーと、頑張れ
質問されれば頑張って説明します

懸念事項としてはメモリ食うんじゃね疑惑（起動が遅くなるかな？）
このシステムをこんだけ本格的に運用するの初めてだからね


・@PRINT_STATE_CLOTH
装備品の表示順序を変更した上で多機能化した@SHOW_CLOTHESを作成
やろうと思えば現在衣装以外の表示もできるようになった


・@ENDUFUFU(ARG)
渡されていない引数ARG:1をカウンタに使用してループをぶん回すというトンデモリセット処理を発見したのでVARSETで書き換え
名無しプライベート変数ならせめてLOCALにしてくれ、たのむから
（@COM751も同様の処理でPLAYER:1をカウンタに使用してたのでVARSETに変更）


・@COM429関連
全般に切り刻んだ結果、原型をとどめていない
手動着せ替えも簡単に実装できそうだけどとりあえず保留


・能力表示関連
全面改訂、主に機能強化
SHOP画面での能力表示関数は結構カッコいい表示だが汎用に使えそうなもんではなかったので
tohoKのキャラリストとeraCUSTOM_Cのキャラリストを混ぜ混ぜしながら魔改造して
ある程度の汎用性を持たせた
なんとなく機能強化されてるはず

１．ショップの能力表示でキャラリストの選択ができるように
２．行動中の能力表示でTARGETの能力を表示する際に「前のキャラ」「次のキャラ」が使えるように
　　リスト端からさらに進もうとすると反対の端に飛びます
３．目についた範囲でカラーバーの色を統一、体力：緑、気力：青、酒気：赤
４．あなたの個人情報欄で妙に処理が重いのが気になったので直した
　　処理が重い原因はランキング処理で全キャラソートを5回も行なっていたため
　　CARRAY系の命令で書き換えました
　　表示のもたつきがなくなったよ

作ったのはいいが↓こいつら改造しにくくなってしまったと思う
@SHOW_CHARA_LIST、@SORT_LIST、@CHARA_BUTTON
副産物として生まれた汎用関数はCOMMONにつっこんだ


・@Show_CharaData
他でも使えるかと思ったら能力表示しか想定してない
微妙に使いづらかったので廃止
リストの切替とかもあったら便利と思ったので自作
そして出来たのが@SHOW_CHARA_LIST関数、しかしこれも多機能すぎて使いにくい場面がある


・@SIMPLE_CHARA_LIST
これは@SHOW_CHARA_LISTが多機能すぎて使いづらいのでつくった関数
指定リストのCALLNAMEをボタンとしてずらっとならべるだけ
TARGETとGET_TARGETNUM()を渡せばTARGETだけリストにして表示してくれる
先にリスト配列を作成して渡さないと機能しませんです
ページ送りなんて気の利いた機能も無い


・@PRINT_STATE
USERCOMで使用していたものを別関数に置き換えた
MASTER側＝SINGLE_CHARA_STATE
TARGET側＝LIST_CHARA_STATE
これにより、TARGETの能力表示は複数のTARGETのページを切り替えられるようになったぞ


・@脱衣処理
引数の意味合いが不明瞭だったのでDIMった上で整理した


・@服を脱がせる
GOTOを多用すると$ラベルの名前＆位置の記憶で脳ミソの一時記憶領域が無駄に圧迫されるので
INPUTループをDO-LOOPに置き換えて不要なものを削除
すっきり


・@CLOTHES_SETTING
普段着への着替え処理を行なっていたが廃止
衣装更新は@SELECT_CLOTHES～@CHANGE_CLOTHES
現在衣装の着替えは@CTRL_CLOTHES_SET

・@CLOTHES_SETTING_NIGHT
パジャマへの着替え処理を行なっていたが廃止
衣装更新は@SELECT_CLOTHES～@CHANGE_CLOTHES
現在衣装の着替えは@CTRL_CLOTHES_SET

・@CLOTHES_SETTING_SAVE
プレイヤーが設定した衣装の保存処理、廃止
保存処理は@CTRL_CLOTHES_SETを使用する

・@CLOTHES_SETTING_LOAD
プレイヤーが設定した衣装の読み込み処理、廃止・統合
読み込み処理は@CTRL_CLOTHES_SETを使用する
上記四関数はおそらく消しても問題ない

・@CLOTHES_SETTING_TRAIN
「@CLOTHES_SETTING」系で唯一廃止を免れている
冒頭に処理を追加、靴の脱着判定
冒頭に処理を追加、全裸判定を行ってEQUIP:0を更新する
衣装の脱ぎ着したらほぼこいつを呼ぶのでこれでいいんでは？と思った

・@CLOTHES_RESET
廃止
現在衣装の着替えは@CTRL_CLOTHES_SETに統合

・@OKIGAE
CTRL_CLOTHESを使用する処理に変更、関数の場所を移動させる
@Repowriter_COSTUMEはSYSTEM.ERBにでも移動して
ファイル構成変えちゃった方がわかりやすいと思う
（ニューゲーム以外で使ってないから）

・@EX_COSTUME
特殊衣装への一時的な着せ替えを関数化
キャラデータ関数を参照し、その場面に適合する衣装が存在すればそれに着替える
今のところ、「おうちデート」と「人里デート」の処理しか存在しません

・@DATUI_SHOES
おそらくARG:1 == 1（靴下もいっしょに脱ぐ）を使ってない
これは@CLOTHES_SETTING_TRAINで靴脱ぎ処理を追加したので
ほぼ無用になってると思うが確信が持てないのでとりあえずそのままにしてあります

・@今日のぱんつ
RAND:MAXPANTS＆WHILE文での抽選だとはけないパンツの抽選結果が重複することがある
この方式だと計算量に上限がない（運が悪い・はけないパンツが多すぎるといつまでも処理が続くよ）
そこで配列をシャッフルしてFOR-NEXT文で抽選する方式に切り替えた
FISHER_YATES_SHAFFLEを利用する時点で最低計算数は増えているような気がしないでもない
各キャラごとにMAXPANTS*2程度の計算量は発生している
FISHER_YATES_SHAFFLEつかおうとしたらF関数内部でCALLすんのムリだった

・@睡眠時間(ARG)
このF関数はMASTERの判定をやることを想定していなかったようなので
とりあえずMASTER相手ではCFLAG:MASTER:睡眠を参照するように

・@IN_ROOM_NUMBER(ARG)
これたぶんこれでいいんじゃね？
ざっくり改造

・@CHANGE_WEATHER
パンツ嵐でノーパンが飛んできそうだったので処理に改良を加えた
持ち主の抽選用に新しく@RAND_CHARASELECTという関数を作って
キャラリストの中から1キャラを抽選することができるようにした
これでまんべんなくパンツが飛んで来る

・@TARGETSET_CHACK
それぞれ一関数で
「配列変数にMASTERと同一の場所にいるキャラのリストを作成する（ついでに人数も取得）」
「キャラリスト配列を好感度降順でソートする」ができるようになった
通常は必要ないがOPで「同室更新無し」を指定すると同室フラグが立たなくなる
このオプションはSHOW_STATUSで呼び出す時用


◆その他、個人的な好み
・能力表示画面とTRAIN画面でのカラーバーの色ズレがちょっときになる
　個人的には酒気は赤以外考えられないという感じなので
　能力表示側の体力緑、気力青、酒気赤、TSP水色を推したい
・TRAIN画面でのカラーバーは常に左：MASTER、右：TARGETの方が好み
　MASTERは画面からいなくならないため、レイアウトが固定化できる
　あなたのバーの位置が左に行ったり右に行ったりしない



◆つくったひと：morph
・配布・改造・流用、好きにしてください
・でも、その際のサポートは自分でやってね

※　era＝R-18全般の常識的な取り扱いとして例えば以下のような事はやめて下さい

・未成年者がいっぱいいる場所で広める
・R-18以外のモノをメインに扱ってる場所で取り上げる
