@NPC_MOVEMENT(ARG)
IF TCVAR:ARG:目的地区 != CFLAG:ARG:現在地区
;;;地区が違う場合の処理
	CFLAG:ARG:移動した = 1
	IF CFLAG:ARG:現在位置 == MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区)
		CALL NPC_AREA_MOVE(ARG)
	ELSE
		CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区))
		IF RESULT
			LOCAL:1 = RESULT
			CFLAG:ARG:現在位置 = MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区)
			CFLAG:ARG:待機時間 += LOCAL:1
		ELSE
			CALLFORM FARMOVE_{CFLAG:ARG:現在地区}(ARG,MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区))
			LOCAL:2 = RESULT
			CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,LOCAL:2)
			CFLAG:ARG:待機時間 += RESULT
			CFLAG:ARG:現在位置 = LOCAL:2
		ENDIF

	ENDIF
ELSEIF TCVAR:ARG:目的位置 != CFLAG:ARG:現在位置
;;;位置が違う場合の処理
	CFLAG:ARG:移動した = 1
	CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,TCVAR:ARG:目的位置)
	IF RESULT
		LOCAL:1 = RESULT
		CFLAG:ARG:現在位置 = TCVAR:ARG:目的位置
		TCVAR:ARG:目的位置 = 0
		TCVAR:ARG:目的地区 = 0
		CFLAG:ARG:待機時間 = LOCAL:1
	ELSE
		CALLFORM FARMOVE_{CFLAG:ARG:現在地区}(ARG,TCVAR:ARG:目的位置)
		LOCAL:2 = RESULT
		CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,LOCAL:2)
		CFLAG:ARG:待機時間 += RESULT
		CFLAG:ARG:現在位置 = LOCAL:2
	ENDIF
ELSE
;;;到着時の処理
		SIF CFLAG:ARG:移動した && TCVAR:ARG:目的位置 && ARG != 1
			TB:(CFLAG:ARG:現在地区):(CFLAG:ARG:現在位置):ARG += 1
		TCVAR:ARG:目的位置 = 0
		TCVAR:ARG:目的地区 = 0
		CFLAG:ARG:待機時間 = 0
		CFLAG:ARG:移動した = 0
ENDIF

[SKIPSTART]
;待機時間が溜まるまで移動を続ける 目的地に着いたら待機時間は0に
DO
	IF TCVAR:ARG:乗車
		CFLAG:ARG:現在地区 = TCVAR:ARG:到着地区
		CFLAG:ARG:現在位置 = TCVAR:ARG:到着位置
		TCVAR:ARG:乗車 = 0
	ELSE
		IF TCVAR:ARG:目的地区 != CFLAG:ARG:現在地区
			IF CFLAG:ARG:現在位置 == MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区)
				CALL NPC_AREA_MOVE(ARG)
			ELSE
				CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区))
				IF RESULT
					LOCAL:1 = RESULT
					CFLAG:ARG:現在位置 = MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区)
					CFLAG:ARG:待機時間 += LOCAL:1
				ELSE
					CALLFORM FARMOVE_{CFLAG:ARG:現在地区}(ARG,MOVE_CHECKPOINT(CFLAG:ARG:現在地区,TCVAR:ARG:目的地区))
					LOCAL:2 = RESULT
					CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,LOCAL:2)
					CFLAG:ARG:待機時間 += RESULT
					CFLAG:ARG:現在位置 = LOCAL:2
				ENDIF

			ENDIF
		ELSEIF TCVAR:ARG:目的位置 != CFLAG:ARG:現在位置
			CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,TCVAR:ARG:目的位置)
			IF RESULT
				LOCAL:1 = RESULT
				CFLAG:ARG:現在位置 = TCVAR:ARG:目的位置
				TCVAR:ARG:目的位置 = 0
				TCVAR:ARG:目的地区 = 0
				CFLAG:ARG:待機時間 = 0
			ELSE
				CALLFORM FARMOVE_{CFLAG:ARG:現在地区}(ARG,TCVAR:ARG:目的位置)
				LOCAL:2 = RESULT
				CALLFORM CAN_MOVE_{CFLAG:ARG:現在地区}(CFLAG:ARG:現在位置,LOCAL:2)
				CFLAG:ARG:待機時間 += RESULT
				CFLAG:ARG:現在位置 = LOCAL:2
			ENDIF
		ELSE
				TCVAR:ARG:目的位置 = 0
				TCVAR:ARG:目的地区 = 0
				CFLAG:ARG:待機時間 = 0
		ENDIF
	ENDIF
LOOP CFLAG:ARG:待機時間 < 0
[SKIPEND]

;目的地が別の地区にある場合とりあえずどこを目指すか返す
;ARG 現在地区 ARG:1 目的地区 RETURNF 暫定的な目的位置
@MOVE_CHECKPOINT(ARG,ARG:1)
#FUNCTION
SELECTCASE ARG
	CASE 0
		SELECTCASE ARG:1
			CASE 1
				RETURNF 3
			CASE 2
				RETURNF 3
		ENDSELECT
	CASE 1
		SELECTCASE ARG:1
			CASE 0
				RETURNF 1
			CASE 2
				RETURNF 1
		ENDSELECT

	CASE 2
		SELECTCASE ARG:1
			CASE 0
				RETURNF 3
			CASE 1
				RETURNF 1
		ENDSELECT

ENDSELECT


@NPC_AREA_MOVE(ARG)
IF CFLAG:ARG:現在地区 == 0 && CFLAG:ARG:現在位置 == 3
	MONEY:ARG -= 200
	CFLAG:ARG:到着地区 = 2
	CFLAG:ARG:到着位置 = 3
	SIF TALENT:ARG:痴漢
		BASE:ARG:評判 -= 20
	IF TIME % 10 == 0
		CFLAG:ARG:乗車 = 1
		CFLAG:ARG:待機時間 = TRAIN_TIME(ARG,CFLAG:ARG:到着地区,CFLAG:ARG:到着位置)
		CFLAG:ARG:到着時間 = TIME + TRAIN_TIME(ARG,CFLAG:ARG:到着地区,CFLAG:ARG:到着位置)
	ELSE
		CFLAG:ARG:乗車 = 2
		CFLAG:ARG:待機時間 = 10 - TIME % 10
		CFLAG:ARG:到着時間 = TIME + CFLAG:ARG:待機時間 + TRAIN_TIME(ARG,CFLAG:ARG:到着地区,CFLAG:ARG:到着位置)
	ENDIF
ELSEIF CFLAG:ARG:現在地区 == 1 && CFLAG:ARG:現在位置 == 1
	CFLAG:ARG:現在地区 = 2
	CFLAG:ARG:現在位置 = 1
	CFLAG:ARG:待機時間 += 1
ELSEIF CFLAG:ARG:現在地区 == 2 && CFLAG:ARG:現在位置 == 1
	CFLAG:ARG:現在地区 = 1
	CFLAG:ARG:現在位置 = 1
	CFLAG:ARG:待機時間 += 1
ELSEIF CFLAG:ARG:現在地区 == 2 && CFLAG:ARG:現在位置 == 3
	MONEY:ARG -= 200
	CFLAG:ARG:到着地区 = 0
	CFLAG:ARG:到着位置 = 3
	SIF TALENT:ARG:痴漢
		BASE:ARG:評判 -= 20
	IF TIME % 10 == 0
		CFLAG:ARG:乗車 = 1
		CFLAG:ARG:待機時間 = TRAIN_TIME(ARG,CFLAG:ARG:到着地区,CFLAG:ARG:到着位置)
		CFLAG:ARG:到着時間 = TIME + CFLAG:ARG:待機時間
	ELSE
		CFLAG:ARG:乗車 = 2
		CFLAG:ARG:待機時間 = 10 - TIME % 10
		CFLAG:ARG:到着時間 = TIME + CFLAG:ARG:待機時間 + TRAIN_TIME(ARG,CFLAG:ARG:到着地区,CFLAG:ARG:到着位置)
	ENDIF
ENDIF
