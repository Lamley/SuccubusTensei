;痴漢イベント
;イベント発生条件
@EVENT_CHECK_1(ARG)
VARSET LOCAL
SIF TCVAR:MASTER:イベント == 3
	RETURN 0
IF CFLAG:MASTER:乗車 == 1 && CFLAG:MASTER:到着地区 == CFLAG:ARG:到着地区 && CFLAG:MASTER:到着位置 == CFLAG:ARG:到着位置 && (CFLAG:MASTER:到着時間 <= CFLAG:ARG:到着時間 && (CFLAG:MASTER:到着時間 + 5) > CFLAG:ARG:到着時間)
	IF (BASE:MASTER:刺激度 * 3 + BASE:MASTER:容姿) * SQRT(BASE:ARG:興奮度 * TALENT:ARG:痴漢) * CROWDED_TRAINS() / 1000 > 300 - FLAG:危険度 * 100 + RAND(300)
		TCVAR:ARG:イベント = 1
		TCVAR:MASTER:イベント = 1
		TCVAR:ARG:行為対象 = MASTER
		TCVAR:ARG:目的位置 = 0
		TCVAR:ARG:目的地区 = 0
		CFLAG:MASTER:待機時間 = 0
		IF !TCVAR:MASTER:行為対象
			TCVAR:MASTER:行為対象 = ARG
			TARGET = ARG
		ENDIF
		T:101 = 0
		T:102 = 0
		T:103 = 0
		T:104 = 0
		T:105 = 0
		RETURN 1
	ENDIF
ENDIF


;イベント終了条件
@EVENT_END_CHECK_1
IF TFLAG:騒ぎ > CROWDED_TRAINS() && BASE:MASTER:評判 > 200
	TFLAG:イベント変数 = 1
ELSEIF TIME >= CFLAG:MASTER:到着時間
	TFLAG:イベント変数 = 2
;ELSEIF BASE:(TCVAR:MASTER:行為対象):興奮度 < 100
;	TFLAG:イベント変数 = 3
ELSEIF TFLAG:イベント変数 == 4
	
ELSE
	RETURN 0
ENDIF
TFLAG:イベント終了 = 1
RETURN 1



;イベント終了処理
@EVENT_END_1
FLAG:痴漢され中 = 0

CFLAG:MASTER:現在位置 = CFLAG:MASTER:到着位置
CFLAG:MASTER:現在地区 = CFLAG:MASTER:到着地区
TCVAR:MASTER:601 = 0
TCVAR:MASTER:挿入 = 0
TCVAR:MASTER:被挿入 = 0
SIF TEQUIP:MASTER:膣 == 1
	TEQUIP:MASTER:膣 = 0
SIF TEQUIP:MASTER:アナル == 60 || TEQUIP:MASTER:アナル == 61 || TEQUIP:MASTER:アナル == 62
	TEQUIP:MASTER:アナル = 0
SELECTCOM:1 = 0
FOR LOCAL,1,CHARANUM
	SIF TCVAR:LOCAL:行為対象 != MASTER
		CONTINUE
	CFLAG:LOCAL:現在位置 = CFLAG:LOCAL:到着位置
	CFLAG:LOCAL:現在地区 = CFLAG:LOCAL:到着地区
	SIF TEQUIP:LOCAL:膣 == 1
		TEQUIP:LOCAL:膣 = 0
	SIF TEQUIP:LOCAL:アナル == 60 || TEQUIP:LOCAL:アナル == 61 || TEQUIP:LOCAL:アナル == 62
		TEQUIP:LOCAL:アナル = 0
	TCVAR:LOCAL:挿入 = 0
	TCVAR:LOCAL:被挿入 = 0
	TCVAR:LOCAL:601 = 0
	TCVAR:LOCAL:乗車 = 0
	SELECTCOM:LOCAL = 0
NEXT

IF TIME < CFLAG:MASTER:到着時間
	CALL TIME_COUNT(CFLAG:MASTER:到着時間 - TIME)
ELSE
	TIME = CFLAG:MASTER:到着時間
ENDIF
CFLAG:MASTER:到着位置 = 0
CFLAG:MASTER:到着地区 = 0
CFLAG:MASTER:乗車 = 0
TFLAG:騒ぎ = 0
VARSET LOCAL

RETURN 1


@NPC_ACTION_1(ARG)
VARSET LOCAL

FOR LOCAL,810 ,820
	CALLFORM COM_ABLE{LOCAL}(ARG)
	SIF !RESULT
		CONTINUE
	LOCAL:1 = RAND(100)
	IF LOCAL:2 < LOCAL:1
		LOCAL:2 = LOCAL:1
		LOCAL:3 = LOCAL
	ENDIF
NEXT
SELECTCOM:ARG = LOCAL:3




;電車の時間帯による混雑状況
@CROWDED_TRAINS
#FUNCTION
SELECTCASE TIME
	CASE 420 TO 600 , 1080 TO 1260
		RETURNF 10
	CASEELSE
		RETURNF 1
ENDSELECT